<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Zay Shop - Product Detail Page</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <link rel="apple-touch-icon" th:href="@{img/apple-icon.png}"/>
    <link rel="shortcut icon" type="image/x-icon" th:href="@{img/favicon.ico}"/>

    <link rel="stylesheet" th:href="@{/website/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/website/css/templatemo.css}"/>
    <link rel="stylesheet" th:href="@{/website/css/custom.css}"/>
    <!-- Google Web Fonts -->
    <link rel="preconnect" th:href="@{https://fonts.googleapis.com}"/>
    <link rel="preconnect" th:href="@{https://fonts.gstatic.com}" crossorigin/>
    <link
            th:href="@{https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Playfair+Display:wght@700;900&display=swap}"
            rel="stylesheet"
    />

    <!-- Icon Font Stylesheet -->
    <link
            th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css}"
            rel="stylesheet"
    />
    <link
            th:href="@{://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css}"
            rel="stylesheet"
    />

    <!-- Libraries Stylesheet -->
    <link th:href="@{/website/lib/animate/animate.min.css}" rel="stylesheet"/>
    <link th:href="@{/website/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet"/>

    <!-- Customized Bootstrap Stylesheet -->
    <!-- <linkth:href="@{/website/css/bootstrap.min.css" rel="stylesheet" /> -->

    <!-- Template Stylesheet -->
    <link th:href="@{/website/css/style.css}" rel="stylesheet"/>

    <!-- Load fonts style after rendering the layout styles -->
    <link
            rel="stylesheet"
            th:href="@{https://fonts.googleapis.com/css2?family=Roboto:wght@100;200;300;400;500;700;900&display=swap}"
    />
    <link rel="stylesheet" th:href="@{/website/css/fontawesome.min.css}"/>
    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css}">

    <!-- Slick -->
    <link rel="stylesheet" type="text/css" th:href="@{/website/css/slick.min.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/website/css/slick-theme.css}"/>
    <!--

TemplateMo 559 Zay Shop

https://templatemo.com/tm-559-zay-shop

-->
    <style>
        .hidden {
            display: none;
        }

    </style>
    <!-- ... (Các khai báo khác như trong mã HTML trước) ... -->
</head>
<body ng-app="shopping-cart-app" ng-controller="shopping-cart-ctrl">
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <table class="table">
                <thead>
                <tr>
                    <th>Tên</th>
                    <th>Ảnh</th>
                    <th>Giá</th>
                    <th>Số lượng</th>
                    <th>Tổng</th>
                </tr>
                </thead>
                <tbody>


                <tr ng-repeat="sl in cartItems">
                    <td> {{sl.producDetail.productId.name}}</td>
                    <td>
<!--                        <img-->
<!--                                th:src="@{'/cart/display?id=' + ${sl.productDetails.productId.id}}"-->
<!--                                alt="Sản phẩm 1"-->
<!--                                style="max-width: 80px; max-height: 80px"-->
<!--                        />-->
                    </td>
                    <td> {{sl.sellPrice | number : 2}} VND</td>
                    <td>
                        <input ng-change="cart.update(sl.id, sl.quantity)" ng-model="sl.quantity" type="number" min="1" />
                    </td>

                    <td> {{sl.producDetail.sellPrice * sl.quantity | number : 3}} VND</td>
                    <td>
                        <button class="btn btn-danger" ng-click="cart.remove(sl.id)">Remove</button>
                    </td>
                </tr>

                </tbody>
            </table>
            <div class="row">
                <div class="col-md-12">
                    <p> Tổng tiền: {{totalPrice | number : 3}} VND</p>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="panel panel-primary">
                <br>
                <div class="panel-heading" style="font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif; font-size: 20px;font-weight: bold; padding-left: 8px; ">Thông tin của bạn</div>
                <br>
                <div class="panel-body">
                    <div class="row">
                        <div class="form-group col-sm-6">

                        </div>
                        <!--                <div class="form-group col-sm-6">-->
                        <!--                    <div>Order Date:</div>-->
                        <!--                    <div class="form-control">{{oder.createDate | date :'dd-MM-yyyy'}}</div>-->
                        <!--                </div>-->
                    </div>
                    <div class="row">
                        <div class="form-group col-sm-12">
                            <label style="font-weight: bold;">Địa chỉ: </label>
                            <input  ng-model="orders.address" class="form-control" style="width: 458px;">
                        </div>

                        <div class="form-group col-sm-12">
                            <div style="font-weight: bold;">SDT:</div>
                            <input  ng-model="orders.phone" class="form-control" style="width: 458px;">
                        </div>
                    </div>

                    <br>
                    <div class="row">
                        <div class="col-md-4">
                            <label style="font-weight: bold; float: left;margin-top: 5px;">Khuyến mãi:</label>



                            <input ng-model="kmMa" class="form-control" placeholder="Nhập mã khuyến mãi" style="width: 240px; margin-left: 10px; float: left;">
                        </div>
                        <div class="col-md-8">
                            <button class="btn btn-success" ng-click="cart.addKM()">Áp dụng</button>
                        </div>
                    </div>

                </div>
                <br>
                <div class="panel-footer text-right">
                    <button ng-click="orders.purchase()" class="btn btn-success">Purchase</button>
                </div>
            </div>
        </div>
    </div>
    <!--    </form>-->
</div>

<!-- Liên kết với tệp JavaScript của Bootstrap (tuỳ chọn) -->
<script th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js}"></script>
<!-- Liên kết với tệp bi-icons của Bootstrap (để sử dụng bi bi-trash) -->
<script th:src="@{https://cdn.jsdelivr.net/npm/bootstrap-icons@1.20.0/font/bootstrap-icons.css}"></script>
<!-- ... (các liên kết và mã HTML khác) ... -->
<script src="/dashboard/js/shopping-cart-app.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var colors = document.querySelectorAll('.color-label');
        var sizes = document.querySelectorAll('.size-label');

        var colorsSelected = false;
        var sizesSelected = false;

        colors.forEach(function (color) {
            color.addEventListener('click', function () {
                if (this.classList.contains('selected-color')) {
                    this.classList.remove('selected-color');
                    colorsSelected = false;
                } else {
                    colors.forEach(function (color) {
                        color.classList.remove('selected-color');
                    });
                    this.classList.add('selected-color');
                    colorsSelected = true;
                }
                showImage();
                checkAndSendData(); // Kiểm tra và gửi dữ liệu
            });
        });

        sizes.forEach(function (size) {
            size.addEventListener('click', function () {
                if (this.classList.contains('selected-size')) {
                    this.classList.remove('selected-size');
                    sizesSelected = false;
                } else {
                    sizes.forEach(function (size) {
                        size.classList.remove('selected-size');
                    });
                    this.classList.add('selected-size');
                    sizesSelected = true;
                }
                showImage();
                checkAndSendData(); // Kiểm tra và gửi dữ liệu
            });
        });

        function checkAndSendData() {
            if (colorsSelected && sizesSelected) {
                sendSelectedData(); // Gọi khi cả hai đều được chọn
            }
        }

        var xhr = new XMLHttpRequest();

        function showImage() {
            var selectedColor = document.querySelector('.selected-color');
            var selectedSize = document.querySelector('.selected-size');
            var productId = document.getElementById('product-id').textContent;
            var colorId = selectedColor ? selectedColor.getAttribute('for').replace('mauSac_', '') : null;
            var sizeId = selectedSize ? selectedSize.getAttribute('for').replace('kichThuoc_', '') : null;

            xhr.open('POST', '/product/detailImage', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
            xhr.onload = function () {
                if (xhr.status >= 200 && xhr.status < 400) {
                    document.getElementById('product-image').src = '/assets/images/' + JSON.parse(xhr.responseText).hinhAnh + '.jpg';
                }
            };
            xhr.send('colorId=' + colorId + '&sizeId=' + sizeId + '&productId=' + productId);
        }

        function sendSelectedData() {
            var cartButton = document.getElementById('cart-button');
            var dataId = null;
            var selectedColor = document.querySelector('.selected-color');
            var selectedSize = document.querySelector('.selected-size');
            var productId = document.getElementById('product-id').textContent;
            var colorId = selectedColor ? selectedColor.getAttribute('for').replace('ms', '') : null;
            var sizeId = selectedSize ? selectedSize.getAttribute('for').replace('kt', '') : null;

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/product/detail', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
            xhr.onload = function () {
                if (xhr.status >= 200 && xhr.status < 400) {
                    var data = JSON.parse(xhr.responseText);

                    cartButton.removeAttribute("disabled");
                    dataId = data.id !== null ? data.id : null;
// // Cập nhật thuộc tính ng-click
                    cartButton.setAttribute("ng-click", "cart.addToCart('" + dataId + "')");
//
// Biên dịch lại nút "Cart"
                    var $injector = angular.injector(['ng']);
                    $injector.invoke(['$compile', function ($compile) {
                        var $scope = angular.element(cartButton).scope();
                        $compile(cartButton)($scope);
                    }]);
                    updateProductDetails(data);

                } else if (xhr.status === 404 || JSON.parse(xhr.responseText).soLuong < 1) {
                    showImage();
                    cartButton.setAttribute("disabled", "true");
                    cartButton.removeAttribute("ng-click");
                    document.getElementById('product-quantity').innerText = 'Số lượng: Hết hàng';
                }

            };
            xhr.send('colorId=' + colorId + '&sizeId=' + sizeId + '&productId=' + productId);

        }

        function updateProductDetails(data) {
            var sl = data;
            document.getElementById('product-price').innerText = sl.sellPrice;
            document.getElementById('product-quantity').innerText = 'Số lượng: ' + sl.quantity;
        }
    });


    const app = angular.module("shopping-cart-app", []);

    app.controller("shopping-cart-ctrl", function ($scope, $http) {
        $scope.dataId = null;
        $scope.totalQuantity = 0;
        $scope.kmMa = "";
        $scope.totalPrice = 0;
        // $scope.tongTienTT = 0;
        $scope.total = 0;
        $scope.KM = null;

        // Khởi tạo biến để điều khiển hiển thị link Admin
        $scope.showAdminLink = false;

        // Hàm để kiểm tra vai trò và hiển thị link nếu là ADMIN hoặc STAFF
        function checkUserRole(roles) {
            if (roles.includes('ADMIN') || roles.includes('ROLE')) {
                $scope.showAdminLink = true;
            }
        }

        // Gọi API để lấy vai trò của người dùng
        function getAuthor() {
            $http.get('/api/user/role')
                .then(function(response) {
                    var userRoles = response.data;
                    checkUserRole(userRoles);
                })
                .catch(function(error) {
                    console.error('Error fetching user roles:', error);
                });
        }
        getAuthor();
        function reloadCartItems() {
            $http.get('/cart/view-cart')
                .then(function (response) {
                    $scope.cartItems = response.data;
                    calculateTotals();
                });
        }

        function calculateTotals() {
            $scope.totalQuantity = 0;
            $scope.total = 0;

            for (let i = 0; i < $scope.cartItems.length; i++) {
                let sl = $scope.cartItems[i];
                $scope.totalQuantity++; // Tăng totalQuantity sau mỗi vòng lặp
                $scope.total += (sl.producDetail.sellPrice * sl.quantity);
            }

            $scope.totalPrice = $scope.total - ($scope.KM !== null ? $scope.KM.giaTri : 0);
        }


        $scope.cart = {
            addToCart(productId) {
                $http.post('/rest/cart/add', {productId: productId})
                    .then(function (response) {
                        console.log(productId)
                        if (response.data) {
                            reloadCartItems(); // Tải lại danh sách sau khi thêm thành công
                        } else {
                            alert("Thêm vào giỏ hàng không thành công!");
                        }

                    })
                    .catch(function (error) {
                        alert("Vui lòng đăng nhập");
                        console.error(error);
                    });

            },

            remove(productId) {
                $http.post('/rest/cart/remove', {productId: productId})
                    .then(function (response) {
                        alert("Xóa sản phẩm khỏi giỏ hàng thành công!");
                        reloadCartItems(); // Tải lại danh sách sau khi xóa thành công
                    })
                    .catch(function (error) {
                        alert("Có lỗi xảy ra khi gọi API!");
                        console.error(error);
                    });
            },

            update(productId, quantity) {
                $http.post('/rest/cart/update', {productId: productId, quantity: quantity})
                    .then(function (response) {
                        if (response.data) {
                            alert("Cập nhật giỏ hàng thành công!");
                            reloadCartItems(); // Tải lại danh sách sau khi cập nhật thành công
                        } else {
                            alert("Cập nhật giỏ hàng không thành công!");
                        }
                    })
                    .catch(function (error) {
                        alert("Có lỗi xảy ra khi gọi API!");
                        console.error(error);
                    });
            },
            clear() {
                $http.post('/rest/cart/clear')
                    .then(function (response) {
                        alert("Xóa tất cả sản phẩm khỏi giỏ hàng thành công!");
                        reloadCartItems(); // Tải lại danh sách sau khi xóa thành công
                    })
                    .catch(function (error) {
                        alert("Có lỗi xảy ra khi gọi API!");
                        console.error(error);
                    });
            },

        }
        reloadCartItems();

        $scope.orders = {
            createDate: new Date(),
            shippingFee : 0,
            // tongTienTT: 0,  // Khởi tạo giá trị ban đầu
            // tongTienKhuyenMai: 0,  // Khởi tạo giá trị ban đầu
            total: 0,  // Khởi tạo giá trị ban đầu
            phone: "",
            address: "",
            orderStatus: 2,
            get orderItem() {
                return $scope.cartItems.map(sl => {
                    return {
                        sellPrice: sl.producDetail.sellPrice,
                        quantity: sl.quantity,
                        producDetail: {id: sl.producDetail.id}
                    }
                });
            },
            purchase() {
                var orders = angular.copy(this);

                // Cập nhật giá trị
                // order.tongTienTT = $scope.totalPrice;
                order.total = $scope.total;

                console.log(order);

                $http.post("/rest/order/add", orders).then(resp => {
                    alert("Dat hang thanh cong");
                    console.log(resp.data);
                    location.href = "/product/hien-thi";

                }).catch(error => {
                    alert("Dat hang loi");
                    console.log(error);
                });
            }
        }


    });
</script>
<!--<script>-->

<!--    const quantityInputs = document.querySelectorAll(".quantity");-->
<!--    const priceElements = document.querySelectorAll(".price");-->
<!--    const subtotalElements = document.querySelectorAll(".subtotal");-->
<!--    const totalElement = document.getElementById("total");-->
<!--    const emptyCartText = document.getElementById("emptyCartText");-->
<!--    const diaChiInput = document.getElementById("diaChi");-->
<!--    const phiGiaoHangLabel = document.getElementById("phiGiaoHangLabel");-->
<!--    const tongTienLabel = document.getElementById("tongTienLabel");-->
<!--    const phieuGiamGiaSelect = document.getElementById("phieuGiamGia");-->
<!--    let phiGiaoHangValue = 0;-->
<!--    let phieuGiamGiaValue = 0;-->

<!--    function formatToVND(amount) {-->
<!--        return new Intl.NumberFormat("vi-VN", {-->
<!--            style: "currency",-->
<!--            currency: "VND",-->
<!--        }).format(amount);-->
<!--    }-->

<!--    function updateTotal() {-->
<!--        let total = 0;-->
<!--        let hasProducts = false;-->
<!--        for (let i = 0; i < quantityInputs.length; i++) {-->
<!--            const quantity = parseInt(quantityInputs[i].value);-->
<!--            const price = parseFloat(-->
<!--                priceElements[i].textContent.replace("₫", "").replace(",", "")-->
<!--            );-->
<!--            const subtotal = quantity * price;-->
<!--            subtotalElements[i].textContent = formatToVND(subtotal);-->
<!--            total += subtotal;-->

<!--            if (quantity > 0) {-->
<!--                hasProducts = true;-->
<!--            }-->
<!--        }-->

<!--        if (!hasProducts) {-->
<!--            emptyCartText.style.display = "block";-->
<!--            totalElement.textContent = formatToVND(0);-->
<!--        } else {-->
<!--            emptyCartText.style.display = "none";-->
<!--            totalElement.textContent = formatToVND(total);-->
<!--        }-->

<!--        const tongTien = total - phieuGiamGiaValue + phiGiaoHangValue;-->
<!--        tongTienLabel.textContent = formatToVND(tongTien);-->
<!--    }-->

<!--    quantityInputs.forEach((input) => {-->
<!--        input.addEventListener("change", updateTotal);-->
<!--    });-->

<!--    const removeButtons = document.querySelectorAll(".remove");-->
<!--    removeButtons.forEach((button) => {-->
<!--        button.addEventListener("click", function () {-->
<!--            const row = this.parentElement.parentElement;-->
<!--            const quantityInput = row.querySelector(".quantity");-->
<!--            quantityInput.value = 0;-->
<!--            row.remove();-->
<!--            updateTotal();-->
<!--        });-->
<!--    });-->

<!--    const orderButton = document.querySelector("button.btn.btn-primary");-->
<!--    orderButton.addEventListener("click", function () {-->
<!--        const hoTen = document.getElementById("hoTen");-->
<!--        const diaChi = document.getElementById("diaChi");-->
<!--        const sdt = document.getElementById("sdt");-->
<!--        const phuongThucThanhToan = document.querySelector('input[name="phuongThucThanhToan"]:checked');-->

<!--        hoTen.style.borderColor = "";-->
<!--        diaChi.style.borderColor = "";-->
<!--        sdt.style.borderColor = "";-->

<!--        if (hoTen.value.trim() === "") {-->
<!--            hoTen.style.borderColor = "red";-->
<!--            document.getElementById("error-hoTen").textContent = "Vui lòng nhập họ tên";-->
<!--        } else {-->
<!--            document.getElementById("error-hoTen").textContent = "";-->
<!--        }-->

<!--        if (diaChi.value.trim() === "") {-->
<!--            diaChi.style.borderColor = "red";-->
<!--            document.getElementById("error-diaChi").textContent = "Vui lòng nhập địa chỉ";-->
<!--        } else {-->
<!--            document.getElementById("error-diaChi").textContent = "";-->
<!--        }-->

<!--        if (sdt.value.trim() === "") {-->
<!--            sdt.style.borderColor = "red";-->
<!--            document.getElementById("error-sdt").textContent = "Vui lòng nhập số điện thoại";-->
<!--        } else {-->
<!--            document.getElementById("error-sdt").textContent = "";-->
<!--        }-->

<!--        if (hoTen.value.trim() !== "" && diaChi.value.trim() !== "" && sdt.value.trim() !== "") {-->
<!--            if (phuongThucThanhToan.value === "khiNhanHang") {-->
<!--                alert(`Xác nhận đặt hàng cho ${hoTen.value} tại địa chỉ ${diaChi.value} với số điện thoại ${sdt.value}. Phương thức thanh toán: Thanh toán khi nhận hàng.`);-->
<!--            } else if (phuongThucThanhToan.value === "zaloPay") {-->
<!--                alert(`Xác nhận đặt hàng cho ${hoTen.value} tại địa chỉ ${diaChi.value} với số điện thoại ${sdt.value}. Phương thức thanh toán: Thanh toán bằng ZaloPay.`);-->
<!--            }-->
<!--        }-->
<!--    });-->
<!--    phieuGiamGiaSelect.addEventListener("change", function () {-->
<!--        phieuGiamGiaValue = parseFloat(phieuGiamGiaSelect.value);-->
<!--        updateTotal();-->
<!--    });-->

<!--    diaChiInput.addEventListener("input", function () {-->
<!--        const diaChi = diaChiInput.value.toLowerCase();-->
<!--        phiGiaoHangValue = diaChi.includes("hà nội") ? 0 : 30000;-->
<!--        phiGiaoHangLabel.textContent =-->
<!--            phiGiaoHangValue === 0-->
<!--                ? "Miễn phí giao hàng"-->
<!--                : formatToVND(phiGiaoHangValue);-->
<!--        updateTotal();-->
<!--    });-->
<!--    // document.getElementById('doi').addEventListener('change', function(event) {-->
<!--    //     // Lấy đối tượng form bên trong-->
<!--    //     const form = event.target;-->
<!--    //-->
<!--    //     // Submit form-->
<!--    //     form.submit();-->
<!--    // });-->
<!--    // function updatePrices(input) {-->
<!--    //     var form = input.form;-->
<!--    //     var quantity = input.value;-->
<!--    //     var priceElement = form.querySelector('.subtotal');-->
<!--    //     var unitPrice = parseFloat(form.querySelector('.unit-price').innerText); // Điều chỉnh class này để tìm giá của sản phẩm-->
<!--    //     priceElement.innerText = (unitPrice * quantity).toFixed(2); // Cập nhật giá theo số lượng mới-->
<!--    // }-->
<!--    // const button = document.getElementById("myButton");-->
<!--    // const note = document.getElementById("note");-->
<!--    //-->
<!--    // button.addEventListener("mouseover", () => {-->
<!--    //     note.style.display = "block";-->
<!--    // });-->
<!--    //-->
<!--    // button.addEventListener("mouseout", () => {-->
<!--    //     note.style.display = "none";-->
<!--    // });-->

<!--    window.addEventListener("load", updateTotal);-->

<!--</script>-->
</body>
</html>
